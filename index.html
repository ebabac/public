import React, { useState } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectItem } from '@/components/ui/select';

const distributors = [
  // Placeholder for distributor data to be loaded via Power Automate
  { username: 'distributor1', password: 'pass1', name: 'Distributor 1', labourRate: 50, travelRate: 20, mileageRate: 0.5, partReimbursementRate: 80, obReimbursementRate: 90, currency: 'USD' },
  // Add more distributors here
];

const labourCodes = [
  // Example labour codes
  { code: 'L001', description: 'Engine Check', time: 2 },
  { code: 'L002', description: 'Oil Change', time: 1.5 },
  // Add more labour codes here
];

export default function WarrantyClaimForm() {
  const [user, setUser] = useState(null);
  const [loginData, setLoginData] = useState({ username: '', password: '' });
  const [claimData, setClaimData] = useState({ obSerial: '', vesselName: '', caseNumber: '', warrantyEndDate: '', faultCode: '' });
  const [selectedLabours, setSelectedLabours] = useState([]);
  const [grandTotal, setGrandTotal] = useState(0);

  const handleLogin = () => {
    const foundUser = distributors.find(
      (d) => d.username === loginData.username && d.password === loginData.password
    );
    if (foundUser) setUser(foundUser);
    else alert('Invalid credentials');
  };

  const handleLabourSelect = (code) => {
    const labour = labourCodes.find((l) => l.code === code);
    if (labour) {
      const cost = labour.time * user.labourRate;
      const newLabour = { ...labour, cost };
      const updatedLabours = [...selectedLabours, newLabour];
      setSelectedLabours(updatedLabours);
      setGrandTotal(updatedLabours.reduce((sum, l) => sum + l.cost, 0));
    }
  };

  if (!user) {
    return (
      <Card className="max-w-md mx-auto mt-10 p-4">
        <CardContent>
          <h2 className="text-xl font-bold mb-4">Distributor Login</h2>
          <Input
            placeholder="Username"
            value={loginData.username}
            onChange={(e) => setLoginData({ ...loginData, username: e.target.value })}
            className="mb-2"
          />
          <Input
            type="password"
            placeholder="Password"
            value={loginData.password}
            onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
            className="mb-4"
          />
          <Button onClick={handleLogin}>Login</Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="max-w-2xl mx-auto mt-10 p-6">
      <CardContent>
        <h2 className="text-2xl font-bold mb-4">Warranty Claim Form</h2>
        <div className="mb-4">
          <p><strong>Distributor:</strong> {user.name}</p>
          <p><strong>Labour Rate:</strong> {user.labourRate} {user.currency}</p>
          <p><strong>Travel Rate:</strong> {user.travelRate} {user.currency}</p>
          <p><strong>Mileage Rate:</strong> {user.mileageRate} {user.currency}/mile</p>
          <p><strong>Part Reimbursement Rate:</strong> {user.partReimbursementRate}%</p>
          <p><strong>OB Reimbursement Rate:</strong> {user.obReimbursementRate}%</p>
          <p><strong>Currency:</strong> {user.currency}</p>
        </div>

        <Input
          placeholder="OB Serial Number (20 digits)"
          value={claimData.obSerial}
          onChange={(e) => setClaimData({ ...claimData, obSerial: e.target.value })}
          className="mb-2"
        />
        <Input
          placeholder="Vessel Name"
          value={claimData.vesselName}
          onChange={(e) => setClaimData({ ...claimData, vesselName: e.target.value })}
          className="mb-2"
        />
        <Input
          placeholder="Salesforce Case Number (8 digits)"
          value={claimData.caseNumber}
          onChange={(e) => setClaimData({ ...claimData, caseNumber: e.target.value })}
          className="mb-2"
        />
        <Input
          type="date"
          value={claimData.warrantyEndDate}
          onChange={(e) => setClaimData({ ...claimData, warrantyEndDate: e.target.value })}
          className="mb-2"
        />
        <Input
          placeholder="Fault Code"
          value={claimData.faultCode}
          onChange={(e) => setClaimData({ ...claimData, faultCode: e.target.value })}
          className="mb-4"
        />

        <Select onValueChange={handleLabourSelect}>
          <SelectItem value="" disabled>Select Labour Code</SelectItem>
          {labourCodes.map((labour) => (
            <SelectItem key={labour.code} value={labour.code}>
              {labour.code} - {labour.description} ({labour.time} hrs)
            </SelectItem>
          ))}
        </Select>

        <div className="mt-4">
          <h3 className="text-xl font-bold">Selected Labours</h3>
          {selectedLabours.map((labour, idx) => (
            <p key={idx}>{labour.code} - {labour.description}: {labour.cost.toFixed(2)} {user.currency}</p>
          ))}
          <p className="mt-2 font-bold">Grand Total: {grandTotal.toFixed(2)} {user.currency}</p>
        </div>

        <Button className="mt-4">Confirm and Continue</Button>
      </CardContent>
    </Card>
  );
}
